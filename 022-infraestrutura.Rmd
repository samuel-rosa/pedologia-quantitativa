<!-- # PARTE II -- INFRAESTRUTURA TECNOLÓGICA {-} -->

<!-- # Hardware -->

<!-- # Programas de Computador -->

# Gestão de Dados e Código Fonte

**Atenção!** Este capítulo está em fase de *desenvolvimento*. Visite a [página do projeto][issues] se tiver 
alguma sugestão, dúvida ou estiver disposto a colaborar. Sua opinião/ajuda é muito importante!

## Introdução

Um importante passo consiste na criação do nosso diretório de trabalho. Para isso, acesse seu gerenciador
de diretórios e crie a seguinte estrutura de diretórios em seu local favorito de trabalho:

    projeto
    |- code/       # qualquer código de programação
    |  |- R/       # código de programação em R
    |
    |- data
    |  |- grid/    # dados matriciais
    |  |- R/       # dados no formato *.rda
    |  |- vector/  # dados vetoriais
    |
    |- doc/        # arquivos usados para redigir o relatório
    |  |- fig/     # figuras usadas no relatório

Note que, dentro do nosso diretório de trabalho principal (`projeto`) existem três subdiretórios:
`code`, `data` e `doc`. O primeiro deles, `code`, serve para armazenarmos os arquivos
contendo código de programação em qualquer linguagem. Para cada linguagem criamos um subsubdiretório 
específico. Nesse exemplo, como usaremos apenas o R, criaremos apenas um subsubdiretório chamado R. Ali 
dentro serão armazenados os *scripts* com código de programação do escritos em R.

O segundo subdiretório será utilizado para armazenarmos os dados usados no projeto. Nesse exemplo, são 
três os tipos de dados que utilizaremos, cada um armazenado em um subsubdiretório específico. No 
subsubdiretório `grid` ficarão armazenados os dados matriciais, ou seja, os dados das covariáveis e 
os resultados das predições espaciais. Já no subsubdiretório `vector` ficarão armazenados os dados 
vetoriais, ou seja, aqueles cuja forma de representação espacial pode ser a de pontos, linhas e polígonos. 
Isso inclui os dados de solo e dos limites da área de estudo. Por fim, o subsubdiretório R será
usado para armazenar dados diversos produzidos durante o processamento no R, os quais serão salvos 
usando o formato `rda`.

O terceiro e último subdiretório de nosso diretório de trabalho `projeto`, aqui denominado `doc`,
será usado para armazenar os arquivos usados para redigir os documentos resultantes do projeto.

No RStudio, acesse

    Arquivo > Novo projeto > Diretório existente

e navegue até o diretório recém criado `projeto`. Clique em `Criar projeto`. Toda a 
estrutura de diretórios criada recentemente aparecerá no painel direito inferior do RStudio. Agora crie um
novo arquivo do R e salve-o no diretório `bigdata > code > R`. Será nesse arquivo que você organizará o 
código em R usado para o processamento dos dados. A criação de um projeto no RStudio 
facilita a organização dos dados.
Sempre que uma rotina de análises for desenvolvida no R é preciso definir o diretório de trabalho. O diretório 
de trabalho constitui a pasta em que estão localizados os arquivos contendo os dados a serem analisados. Além 
disso, é no diretório de trabalho que o R salva o histórico de trabalho contendo todas as operações realizadas.

Inicie o QGIS e acesse

    Projeto > Novo > Salvar como

e navegue até o diretório `projeto`. Nomeie o projeto como `projeto`. Assim como para o
RStudio, a criação de um projeto no QGIS facilita a organização dos dados.

## Bases de Dados do Solo

### Perfis do Solo

* CENA-USP: Digital soil properties database of the Amazon part from the RADAMBRASIL project
    + ftp://fapespclima.ccst.inpe.br/lba/ornlworking/carbon_dynamics/CD/CD-208/CD208_RADAMBRASIL_Soils/
* Esalq-USP: A national soil profile database for Brazil available to international scientists
    + http://www.esalq.usp.br/gerd/
* EMBRAPA: Sistema de Informação de Solos Brasileiros
    + https://www.bdsolos.cnptia.embrapa.br/consulta_publica.html
* ISRIC: World Soil Information Service (WoSIS)
    + http://www.isric.org/data/wosis
* NASA: Large-Scale Biosphere-Atmosphere Experiment in Amazonia
    + https://daac.ornl.gov/LBA/lba.shtml

### Mapas do Solo 

* EMBRAPA: GeoPortal Digital
  + http://mapoteca.cnps.embrapa.br/
* ISRIC: SoilGrids
  + https://soilgrids.org/

## Gerenciamento de Código Fonte

### git

O controle de versão é uma prática de fundamental importância para o gerenciamento ao longo do tempo de arquivos em geral, dentre eles arquivos contendo código fonte. Um sistema de controle de versão registra todas as mudança feitas no código fonte. Assim, quando cometemos algum erro ou desenvolvemos o código fonte em uma direção que mais tarde se mostra equivocada, podemos olhar para as versões anteriores do código fonte até encontrarmos o ponto em que erramos ou o momento no qual tomamos aquela direção equivocada. Basta então recuperar aquela versão do código fonte e continuar o seu desenvolvimento.

A estratégia de controle de versão mais comumente usada consiste em manter uma estrutura de arquivos mais ou menos com a seguinte:

    projeto/
    |- code/
    |  |- R/
    |     |- script01.R
    |     |- script01-modificado.R
    |     |- script02.R
    |     |- script02-revisado.R
    |     |- script02-revisado-novo.R
    |     |- script-final.R
    |     |- script-final-final.R

Felizmente existem alternativas bastante mais eficientes do que essa. Na verdade, um bom sistema de control de versão dará conta do registro e organização das diferentes versões do código fonte de maneira completamente automática.

Um dos sistemas mais populares de gerenciamento e controle de versão de código fonte é o [git][git]. Uma das grandes vantagens do git é o fato de ser facilmente instalado e utilizado localmente, em seu computador, sem necessitar da conexão permanente a um servidor remoto centralizador das operações de gerenciamento do código fonte. Isso é muito importante para que possamos fazer o controle de versão do código fonte localmente mesmo tendo acesso limitado ou intermitente ao repositório remoto onde o código fonte fica armazenado e publicado/compartilhado.

[git]: https://git-scm.com/

Outra importante vantagem do git em relação aos demais sistemas de controle de versão é o fato de que permite criar cópias, ramificações (`branch`, do inglês *branching*) do código fonte com as quais podemos fazer testes e desenvolvimentos sem muito comprometimento com o resultado, tudo isso sem tocar na versão estável do código fonte (`master`). Caso os desenvolvimentos em uma ramificação do código fonte se mostrarem uteis, basta fazer uma fusão (`merge`, do inglês *merging*) entre o ramo e o código fonte estável -- ou simplesmente deletar a ramificação caso ela se mostre inútil. Isso é particularmente importante quando mais de uma pessoa está trabalhando no desenvolvimento do código fonte e quando trabalhamos sozinhos mas precisamos fazer uma alteração muito grande no código fonte.

Para verificar se você já tem o git instalado em seu computador, acesse o Terminal -- no painel esquerdo inferior do RStudio -- e emita as linhas de comando abaixo conforme o seu sistema operacional:

```{bash, eval=FALSE}
# Verificação da instalação do git
which git # Linux & Mac
where git # Windows
git --version
```

Se o git estiver instalado, o primeiro comando (`which git`, em Linux e Mac, ou `where git`, em Windows) deverá retornar o caminho para o diretório onde os arquivos do git estão localizados -- por exemplo, `/usr/bin/git` --, enquanto o segundo comando mostra a versão do git que está instalada -- por exemplo, `git version 2.7.4`. Caso você não tenha o git instalado em seu computador, vá até o endereço https://git-scm.com/downloads e descarregue o instalador e estude as diretrizes para instalação para o seu sistema operacional.

Depois de instalado o git, precisamos fazer a sua configuração. Trata-se de informar seu nome e endereço de e-mail para o git. Isso é necessário porque o git registra esses dados à cada edição enviada/submetida (`commit`) ao sistema de controle de versão. Apesar da pequena utilidade quando trabalhamos sozinhos, essa prática é da maior importância quando duas ou mais pessoas colaboram na edição do código fonte, permitindo identificar quem fez cada alteração. Para configurar o seu nome e endereço de e-mail no git, acesse o Terminal -- painel esquerdo inferior do RStudio -- e emita as duas linhas de comando abaixo substituíndo com seus dados os campos pertinentes:

```{bash, eval=FALSE}
# Configuração do git
git config --global user.name 'Seu Nome aqui'
git config --global user.email 'seu@email.aqui'
```

Vamos agora fazer um pequeno exercício usando o git. Para começar, acesse o Terminal no RStudio e emita o comando `git status`. Esse comando produzirá como resultado informações sobre o estado atual do sistema de controle de versão. Entre outras coisas, ele indica o ramo em que estamos trabalhando, nesse caso, o ramo `master`. Para criar um novo ramo usamos o comando `git branch`:

    git branch teste

O comando acima criou um ramo chamado `teste`. Agora precisamos informar o git que as próximas edições feita no código fonte sejam registradas no ramo `teste`. Para mudarmos para o novo ramo usamos o comando `git checkout`:

    git checkout teste

Ou, alternativamente, podemos usar a opção `-b` com o comando `git checkout` para criar e mudar para o novo ramo de uma só vez:

    git checkout -b teste

Se emitirmos novamente o comando `git status`, veremos que estamos, de fato, trabalhando no ramo `teste`. A partir de agora todas as edições são registradas no ramo `teste`. Suponha, por exemplo, que dentre as edições feitas está a criação de um arquivo chamado `teste.txt`. Nesse caso, precisamos adicionar o novo arquivo ao índice do git. Para isso usamo o comando `git add`: 

    git add teste.txt

Também precisamos registrar no git uma mensagem que descreva minimamente nossa ação. Para isso usamos o comando `git commit`:

    git commit -m 'Criação do novo arquivo teste.txt contendo informações sobre o teste'

Enquanto fazemos essas edições no ramo `teste`, o ramo `master` continua exatamente como o deixamos quando criamos e mudamos para o ramo `teste`. Suponha que agora queremos fundir as edições feitas no ramo `teste` com aquelas feitas no ramo `master`. Para isso precisaos primeiro mudar para o ramo `master`:

    git checkout master

Para fundir o ramo `teste` com o ramo `master` usamos o comando `git merge`:

    git merge teste

Caso tenhamos terminado o desenvolvimento no ramo `teste` e não voltaremos mais a usar aquele ramos, podemos deletá-lo. Para isso usamos a opção `-d` com o comando `git branch`:

    git branch -d teste

### GitHub

O [GitHub][github] é uma das plataformas mais populares para hospedagem de código fonte, sobretudo entre os usuários e desenvolvedores de pacotes para o R.

[github]: https://github.com/

Acesse a página do GitHub no endereço abaixo para criar sua conta:

* https://github.com/

## Documentação e Publicação

### Programação letrada

Linguagem de marcação [Markdown do R](http://rmarkdown.rstudio.com/)

[Cadernos de anotações](http://rmarkdown.rstudio.com/r_notebooks.html). 

### Plataformas de publicação

O [Hugo][hugo], um programa de computador gratuito e de código aberto, é um dos geradores de páginas estáticas da Internet mais populares. Um gerador de páginas estáticas consiste num programa que recebe arquivos de texto plano (Markdown) como entrada e os processa de maneira a produzir arquivos no formato HTML. Esses arquivos no formato HTML finalmente vão compor o conteúdo essencial da página da Internet. Qualquer pessoa que acessar uma página estática receberá, em seu computador, exatamente o mesmo conteúdo. Isso é completamente diferente das páginas com conteúdo dinâmico (Figure \@ref(fig:ufsm-page)), as quais podem enviar conteúdos diferentes para as pessoas que a estiverem acessando dependendo de condições específicas. Por exemplo, uma página que exige o cadastro do visitante enviará conteúdo relacionado àquele visitante. Para que isso ocorra, as páginas dinâmicas dependem de uma base de dados e uma linguagem como PHP no servidor para realizar algum processamento antes de enviar o conteúdo da página ao seu visitante. Numa página estática, o conteúdo não fica armazenado em uma base de dados, e sim em arquivos HTML prontos para servir armazenados num servidor qualquer. Assim, as páginas estáticas costumam ser mais rápidas em responder às ações dos visitantes. Elas também são mais fáceis de implementar e manter, uma vez que não dependem de servidores especializados ou a instalação de programas específicos para gerenciamento de conteúdo.

[hugo]: https://gohugo.io/

```{r ufsm-page, echo=FALSE, fig.cap="Página dinâmica da Universidade Federal de Santa Maria.", out.width='80%', fig.align='center'}
knitr::include_url("http://site.ufsm.br/")
```

Existem inúmeros geradores de páginas estáticas da Internet. O Hugo se destaca entre eles por ser de fácil instalação e conter nenhuma ou pouquíssimas dependências (dependendo do sistema operacional). O Hugo também é bastante rápido na geração das páginas e relativamente fácil de configurar se comparado aos demais geradores de páginas estáticas existentes. Além disso, o Hugo possui uma comunidade de usuários bastante ativa, o que facilita as coisas quando precisamos resolver alguma dúvida. Essa atividade reflete no número de [temas][tema-hugo] -- coleção de arquivos de modelos e recursos opcionais (CSS e JavaScript) que definem o aspecto visual da página quando publicada -- disponíveis para instalação.

[tema-hugo]: https://themes.gohugo.io

Visite o endereço abaixo para ver as instruções sobre como instalar a última versão do Hugo:

* https://gohugo.io/getting-started/installing/

Ou, alternativamente, descarregue o instalador para o seu OS do seguinte endereço:

* https://github.com/gohugoio/hugo/releases

A principal deficiência do Hugo -- para usuários do R -- é a falta de suporte para a implementação do Markdown para o R. Isso significa que, na implementação nativa do Hugo, não é nada fácil gerar resultados (figuras, tabelas) usando código do R. Além disso, o Hugo não usa o [Pandoc][pandoc] como motor de conversão de Markdown em HTML. Foi exatamente para sanar essas duas deficiências que o engenheiro de *software* do RStudio [Yihui Xie][yihui-xie] criou o pacote do R [blogdown][blogdown].

[pandoc]: http://pandoc.org/
[blogdown]: https://bookdown.org/yihui/blogdown/
[yihui-xie]: https://yihui.name

```{r, eval=FALSE}
# Instalação da última versão do pacote blogdown e dependências
devtools::install_github("rstudio/blogdown", dependencies = TRUE)
```

Projetos de construção de páginas da Internet usando Hugo e blogdown podem ser facilmente gerenciados usando o RStudio. Para criar um projeto, vá até `File > new Project > New Directory` e escolha `Website using blogdown` (Figura \@ref(fig:website-using-blogdown)).

```{r website-using-blogdown, echo=FALSE, fig.cap='Criação de novo projeto de página da Internet usando blogdown no RStudio.', out.width='50%', fig.align='center'}
knitr::include_graphics('images/website-using-blogdown.png')
```

A próxima caixa de diálogo traz opções para definir o nome do novo diretório e a sua localização no sistema de arquivos de seu computador (Figura \@ref(fig:diretorio-tema-blogdown)). Como você já instalou o Hugo, desabilite a opção `Install Hugo automatically`. Escolha o [tema do Hugo][tema-hugo] indicando o nome do respectivo repositório no GitHub. (Recomendo usar o tema [acadêmico][tema-academico] `gcushen/hugo-academic` 😃)

```{r diretorio-tema-blogdown, echo=FALSE, fig.cap='Escolha do diretório do projeto e tema da página da Internet usando blogdown no RStudio.', out.width='50%', fig.align='center'}
knitr::include_graphics('images/diretorio-tema-blogdown.png')
```

[tema-academico]: https://themes.gohugo.io/academic/
